# 用户行为日志功能测试用例文档

## 一、测试概述

**测试目标**：验证用户行为日志埋点功能在各种场景下的正确性，确保用户操作能够被准确记录到 `user_action_log` 表中。

**测试范围**：
- 用户注册功能（`addUser`）
- 用户登录功能（`loginStatus`、`loginEmailStatus`）
- 用户信息更新功能（`updateUserMsg`）
- 密码修改功能（`updatePassword`、`updatePassword01`）
- 播放歌曲功能（`recordSongPlay`）

**测试环境**：
- JDK 1.8+
- Spring Boot 2.6.2
- JUnit 4
- Mockito

---

## 二、测试用例列表

### 2.1 用户注册功能测试

| 用例编号 | 测试用例名称 | 前置条件 | 测试步骤 | 预期结果 | 埋点验证 | 优先级 |
|---------|------------|---------|---------|---------|---------|--------|
| TC-REG-001 | 注册成功应记录日志 | 无 | 1. 调用 `addUser` 方法<br>2. 传入新用户名、密码、邮箱<br>3. Mock 用户名不存在、邮箱不存在、插入成功 | 返回 `R.success("注册成功")` | 调用 `userActionLogService.recordAction`<br>- userId: 1<br>- action: "REGISTER"<br>- detail: "用户注册成功" | 高 |
| TC-REG-002 | 用户名已存在不应记录日志 | 无 | 1. 调用 `addUser` 方法<br>2. 传入已存在的用户名 | 返回 `R.warning("用户名已注册")` | 不调用 `recordAction` | 高 |
| TC-REG-003 | 邮箱已存在不应记录日志 | 无 | 1. 调用 `addUser` 方法<br>2. 传入已存在的邮箱 | 返回 `R.fatal("邮箱不允许重复")` | 不调用 `recordAction` | 高 |

### 2.2 用户登录功能测试

| 用例编号 | 测试用例名称 | 前置条件 | 测试步骤 | 预期结果 | 埋点验证 | 优先级 |
|---------|------------|---------|---------|---------|---------|--------|
| TC-LOGIN-001 | 用户名登录成功应记录日志 | 无 | 1. 调用 `loginStatus` 方法<br>2. 传入正确的用户名和密码<br>3. Mock 密码验证成功 | 返回 `R.success("登录成功")`<br>Session 中设置 username | 调用 `userActionLogService.recordAction`<br>- userId: 5<br>- action: "LOGIN"<br>- detail: "用户名登录成功" | 高 |
| TC-LOGIN-002 | 用户名登录失败不应记录日志 | 无 | 1. 调用 `loginStatus` 方法<br>2. 传入错误的密码 | 返回 `R.error("用户名或密码错误")` | 不调用 `recordAction` | 高 |
| TC-LOGIN-003 | 邮箱登录成功应记录日志 | 无 | 1. 调用 `loginEmailStatus` 方法<br>2. 传入正确的邮箱和密码<br>3. Mock 邮箱查找和密码验证成功 | 返回 `R.success("登录成功")`<br>Session 中设置 username | 调用 `userActionLogService.recordAction`<br>- userId: 5<br>- action: "LOGIN"<br>- detail: "邮箱登录成功" | 高 |
| TC-LOGIN-004 | 邮箱登录失败不应记录日志 | 无 | 1. 调用 `loginEmailStatus` 方法<br>2. 传入错误的密码 | 返回 `R.error("用户名或密码错误")` | 不调用 `recordAction` | 高 |

### 2.3 用户信息更新功能测试

| 用例编号 | 测试用例名称 | 前置条件 | 测试步骤 | 预期结果 | 埋点验证 | 优先级 |
|---------|------------|---------|---------|---------|---------|--------|
| TC-UPDATE-001 | 更新用户信息成功应记录日志 | 无 | 1. 调用 `updateUserMsg` 方法<br>2. 传入用户ID和更新信息<br>3. Mock 更新成功 | 返回 `R.success("修改成功")` | 调用 `userActionLogService.recordAction`<br>- userId: 5<br>- action: "UPDATE_PROFILE"<br>- detail: "更新用户基本信息" | 高 |
| TC-UPDATE-002 | 更新用户信息失败不应记录日志 | 无 | 1. 调用 `updateUserMsg` 方法<br>2. Mock 更新失败 | 返回 `R.error("修改失败")` | 不调用 `recordAction` | 中 |

### 2.4 密码修改功能测试

| 用例编号 | 测试用例名称 | 前置条件 | 测试步骤 | 预期结果 | 埋点验证 | 优先级 |
|---------|------------|---------|---------|---------|---------|--------|
| TC-PWD-001 | 修改密码成功应记录日志 | 无 | 1. 调用 `updatePassword` 方法<br>2. 传入正确的旧密码和新密码<br>3. Mock 旧密码验证成功、更新成功 | 返回 `R.success("密码修改成功")` | 调用 `userActionLogService.recordAction`<br>- userId: 5<br>- action: "UPDATE_PASSWORD"<br>- detail: "用户修改密码" | 高 |
| TC-PWD-002 | 旧密码错误不应记录日志 | 无 | 1. 调用 `updatePassword` 方法<br>2. 传入错误的旧密码 | 返回 `R.error("密码输入错误")` | 不调用 `recordAction` | 高 |
| TC-PWD-003 | 邮件重置密码成功应记录日志 | 无 | 1. 调用 `updatePassword01` 方法<br>2. 传入用户ID和新密码<br>3. Mock 更新成功 | 返回 `R.success("密码修改成功")` | 调用 `userActionLogService.recordAction`<br>- userId: 5<br>- action: "UPDATE_PASSWORD"<br>- detail: "用户通过邮件重置密码" | 高 |

### 2.5 播放歌曲功能测试

| 用例编号 | 测试用例名称 | 前置条件 | 测试步骤 | 预期结果 | 埋点验证 | 优先级 |
|---------|------------|---------|---------|---------|---------|--------|
| TC-PLAY-001 | 播放歌曲成功应记录日志（提供userId） | 无 | 1. 调用 `recordSongPlay` 方法<br>2. 传入 songId=38, userId=5<br>3. Mock 歌曲存在 | 返回 `R.success("播放记录成功")` | 调用 `userActionLogService.recordAction`<br>- userId: 5<br>- action: "PLAY_SONG"<br>- detail: "播放歌曲：林俊杰-关键词(38)" | 高 |
| TC-PLAY-002 | 播放歌曲成功应记录日志（从session解析userId） | Session中有username | 1. 调用 `recordSongPlay` 方法<br>2. 传入 songId=38, userId=null<br>3. Session中有username="testuser"<br>4. Mock 歌曲存在、用户查询成功 | 返回 `R.success("播放记录成功")` | 调用 `userActionLogService.recordAction`<br>- userId: 9（从session解析）<br>- action: "PLAY_SONG" | 高 |
| TC-PLAY-003 | 无法解析用户不应记录日志 | 无Session且无userId | 1. 调用 `recordSongPlay` 方法<br>2. 传入 songId=38, userId=null<br>3. Session中无username或用户不存在 | 返回 `R.success("播放记录成功")` | 不调用 `recordAction`（匿名用户不记录） | 中 |
| TC-PLAY-004 | 歌曲ID为空应返回错误 | 无 | 1. 调用 `recordSongPlay` 方法<br>2. 传入 songId=null | 返回 `R.error("歌曲ID不能为空")` | 不调用 `recordAction` | 高 |
| TC-PLAY-005 | 歌曲不存在应返回错误 | 无 | 1. 调用 `recordSongPlay` 方法<br>2. 传入不存在的songId | 返回 `R.error("歌曲不存在")` | 不调用 `recordAction` | 高 |

---

## 三、集成测试用例

### 3.1 Web层集成测试

| 用例编号 | 测试用例名称 | 测试步骤 | 预期结果 | 优先级 |
|---------|------------|---------|---------|--------|
| TC-INTEGRATION-001 | `/song/play` 接口应正确调用Service | 1. 发送 POST 请求到 `/song/play`<br>2. 请求体：`{"songId": 38, "userId": 5}`<br>3. Mock `SongService.recordSongPlay` 返回成功 | HTTP 200<br>响应体包含 `{"message": "播放记录成功", "success": true}` | 高 |

---

## 四、测试执行说明

### 4.1 运行单元测试

在 `music-server` 目录下执行：

```bash
mvn test -DskipTests=false
```

或运行特定测试类：

```bash
mvn test -Dtest=ConsumerServiceImplTest
mvn test -Dtest=SongServiceImplTest
mvn test -Dtest=SongControllerTest
```

### 4.2 测试覆盖率目标

- **单元测试覆盖率**：≥ 80%
- **关键业务逻辑覆盖率**：100%（所有埋点分支）

### 4.3 测试数据准备

测试使用 Mock 对象，不依赖真实数据库。所有数据通过 Mockito 模拟。

---

## 五、测试结果统计

| 测试模块 | 用例总数 | 通过 | 失败 | 跳过 | 通过率 |
|---------|---------|------|------|------|--------|
| 用户注册 | 3 | - | - | - | - |
| 用户登录 | 4 | - | - | - | - |
| 用户信息更新 | 2 | - | - | - | - |
| 密码修改 | 3 | - | - | - | - |
| 播放歌曲 | 5 | - | - | - | - |
| Web层集成 | 1 | - | - | - | - |
| **总计** | **18** | - | - | - | - |

*注：执行测试后填写实际结果*

---

## 六、已知问题与限制

1. **头像更新测试**：`updateUserAvator` 方法调用了静态方法 `MinioUploadController.uploadAtorImgFile`，完整测试需要使用 PowerMock 或重构代码使静态方法可测试。当前测试中已跳过该功能。

2. **IP地址获取**：`IpUtils.getClientIp()` 在测试环境中可能返回 "UNKNOWN"，这是正常现象，不影响埋点功能验证。

3. **Session管理**：部分测试需要模拟 HttpSession，使用 Mockito 创建 Mock 对象。

---

## 七、后续优化建议

1. **代码重构**：将 `MinioUploadController.uploadAtorImgFile` 静态方法抽取为可注入的服务，便于单元测试。

2. **测试数据生成**：使用 Builder 模式或测试数据生成工具（如 Faker）简化测试数据准备。

3. **集成测试扩展**：增加端到端测试，验证从 Controller 到数据库的完整流程。

4. **性能测试**：验证大量并发请求下的埋点性能，确保不影响主业务流程。

---

## 八、附录

### 8.1 测试文件清单

- `ConsumerServiceImplTest.java` - 用户服务单元测试
- `SongServiceImplTest.java` - 歌曲服务单元测试（播放记录）
- `SongControllerTest.java` - 歌曲控制器集成测试

### 8.2 相关文档

- [用户行为记录功能说明文档](./用户行为记录功能说明文档.md)
- [问题排查和修复说明](./问题排查和修复说明.md)

---

**文档版本**：v1.0  
**创建日期**：2025-01-29  
**最后更新**：2025-01-29  
**维护人员**：开发团队





