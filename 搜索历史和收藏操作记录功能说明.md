# 搜索历史和收藏操作记录功能说明

## 功能概述

已实现搜索历史和收藏操作的记录功能，具体包括：

### 1. 搜索历史记录

- **数据库表**：`search_history`
  - 字段包括：id, user_id, keyword, search_type, create_time
  - 支持记录用户搜索的关键词和搜索类型（歌曲/歌单）

- **后端实现**：
  - `SearchHistory` 实体类
  - `SearchHistoryMapper` 数据访问层
  - `SearchHistoryService` 服务层
  - `SearchHistoryController` 控制器
  - 在 `SongController` 和 `SongListController` 中自动记录搜索历史

- **前端实现**：
  - 在 `SearchSong.vue` 和 `SearchSongList.vue` 中传递用户ID
  - 更新了 `api/index.ts` 中的搜索API调用

### 2. 收藏操作记录

- **使用现有表**：`user_action_log`
  - 记录收藏和取消收藏操作
  - 包含操作类型、详细信息、用户IP等

- **后端实现**：
  - 在 `CollectServiceImpl` 中添加收藏和取消收藏的操作日志记录
  - 使用 `UserActionLogService` 记录操作

## 数据库表创建

请执行以下SQL创建搜索历史表：

```sql
-- 搜索历史表
DROP TABLE IF EXISTS `search_history`;
CREATE TABLE `search_history` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int(10) unsigned DEFAULT NULL COMMENT '用户ID，可为空表示未登录用户',
  `keyword` varchar(255) NOT NULL COMMENT '搜索关键词',
  `search_type` varchar(20) DEFAULT 'song' COMMENT '搜索类型：song-歌曲，songList-歌单',
  `create_time` datetime NOT NULL COMMENT '搜索时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='搜索历史表';
```

SQL文件位置：`music-server/sql/search_history.sql`

## API接口

### 搜索历史相关

1. **记录搜索历史**
   - 路径：`POST /search/history/record`
   - 参数：userId（可选）, keyword, searchType（可选，默认song）

2. **获取用户搜索历史**
   - 路径：`GET /search/history/user`
   - 参数：userId, limit（可选，默认10）

### 收藏操作

收藏操作会自动记录到 `user_action_log` 表中，包括：
- ADD_COLLECT：添加收藏
- DELETE_COLLECT：取消收藏

## 文件清单

### 后端文件

1. `music-server/src/main/java/com/example/yin/model/domain/SearchHistory.java`
2. `music-server/src/main/java/com/example/yin/mapper/SearchHistoryMapper.java`
3. `music-server/src/main/java/com/example/yin/service/SearchHistoryService.java`
4. `music-server/src/main/java/com/example/yin/service/impl/SearchHistoryServiceImpl.java`
5. `music-server/src/main/java/com/example/yin/controller/SearchHistoryController.java`
6. `music-server/src/main/java/com/example/yin/controller/SongController.java` (已修改)
7. `music-server/src/main/java/com/example/yin/controller/SongListController.java` (已修改)
8. `music-server/src/main/java/com/example/yin/service/impl/CollectServiceImpl.java` (已修改)
9. `music-server/sql/search_history.sql`

### 前端文件

1. `music-client/src/api/index.ts` (已修改)
2. `music-client/src/views/search/SearchSong.vue` (已修改)
3. `music-client/src/views/search/SearchSongList.vue` (已修改)

## 使用说明

1. **执行数据库脚本**：运行 `music-server/sql/search_history.sql` 创建搜索历史表

2. **搜索历史记录**：
   - 用户在搜索时，如果已登录，系统会自动记录搜索关键词
   - 搜索类型会自动识别（歌曲搜索或歌单搜索）

3. **收藏操作记录**：
   - 当用户添加或取消收藏时，系统会自动记录操作日志
   - 日志包含操作类型、详细信息、用户IP等

4. **查询搜索历史**：
   - 可以通过API接口查询用户的搜索历史
   - 支持限制返回数量

## 注意事项

1. 搜索历史记录支持未登录用户（user_id可为null）
2. 收藏操作记录会自动获取用户IP地址
3. 所有操作日志记录是异步的，不会影响主要业务逻辑的性能














