# 搜索历史和收藏操作记录功能 - 问题排查和修复说明

## 已修复的问题

### 1. 修复了 `request.ts` 的错误处理
- **问题**：访问 `error.response.status` 时，`error.response` 可能为 undefined
- **修复**：添加了空值检查，避免访问 undefined 的属性

### 2. 修复了搜索历史记录阻塞搜索的问题
- **问题**：搜索历史记录如果失败，可能会影响搜索功能
- **修复**：
  - 将搜索历史记录改为在搜索完成后执行
  - 添加了异常处理，确保记录失败不影响搜索功能

### 3. 修复了接口参数接收问题
- **问题**：`SearchHistoryController` 使用 `@RequestParam` 但前端发送 JSON
- **修复**：创建了 `SearchHistoryRequest` 类，使用 `@RequestBody` 接收参数

## 网络错误排查步骤

如果遇到 "Network Error"，请按以下步骤排查：

### 1. 确认后端服务已启动
- 检查后端服务是否在运行（默认端口：8081）
- 查看后端控制台是否有错误信息

### 2. 创建数据库表
**重要**：必须先执行以下 SQL 创建搜索历史表：

```sql
-- 搜索历史表
DROP TABLE IF EXISTS `search_history`;
CREATE TABLE `search_history` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int(10) unsigned DEFAULT NULL COMMENT '用户ID，可为空表示未登录用户',
  `keyword` varchar(255) NOT NULL COMMENT '搜索关键词',
  `search_type` varchar(20) DEFAULT 'song' COMMENT '搜索类型：song-歌曲，songList-歌单',
  `create_time` datetime NOT NULL COMMENT '搜索时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='搜索历史表';
```

SQL文件位置：`music-server/sql/search_history.sql`

### 3. 检查数据库连接
- 确认数据库服务正在运行
- 检查数据库连接配置是否正确

### 4. 检查前端配置
- 确认 `NODE_HOST` 环境变量配置正确（应该指向后端服务地址）
- 检查前端和后端的端口配置

### 5. 查看浏览器控制台
- 打开浏览器开发者工具（F12）
- 查看 Network 标签页，找到失败的请求
- 查看错误详情，确认是 404（接口不存在）、500（服务器错误）还是 CORS 错误

## 临时解决方案

如果数据库表尚未创建，可以临时禁用搜索历史记录功能：

1. 注释掉 `SongController.java` 和 `SongListController.java` 中的搜索历史记录代码
2. 或者确保搜索历史记录失败时不影响主要功能（已实现异常处理）

## 功能说明

### 搜索历史记录
- **自动记录**：当用户搜索时，如果已登录，系统会自动记录搜索关键词
- **不影响搜索**：即使记录失败，也不会影响搜索功能的正常使用
- **支持未登录用户**：未登录用户的搜索不会被记录（但搜索功能正常）

### 收藏操作记录
- **自动记录**：添加和取消收藏操作会自动记录到 `user_action_log` 表
- **详细信息**：记录包含操作类型、详细信息、用户IP等

## 相关文件清单

### 后端文件
- `music-server/src/main/java/com/example/yin/model/domain/SearchHistory.java`
- `music-server/src/main/java/com/example/yin/model/request/SearchHistoryRequest.java`
- `music-server/src/main/java/com/example/yin/mapper/SearchHistoryMapper.java`
- `music-server/src/main/java/com/example/yin/service/SearchHistoryService.java`
- `music-server/src/main/java/com/example/yin/service/impl/SearchHistoryServiceImpl.java`
- `music-server/src/main/java/com/example/yin/controller/SearchHistoryController.java`
- `music-server/src/main/java/com/example/yin/controller/SongController.java` (已修改)
- `music-server/src/main/java/com/example/yin/controller/SongListController.java` (已修改)
- `music-server/src/main/java/com/example/yin/service/impl/CollectServiceImpl.java` (已修改)
- `music-server/sql/search_history.sql` (需要执行)

### 前端文件
- `music-client/src/api/request.ts` (已修复错误处理)
- `music-client/src/api/index.ts` (已更新)
- `music-client/src/views/search/SearchSong.vue` (已修改)
- `music-client/src/views/search/SearchSongList.vue` (已修改)

## 下一步操作

1. **执行数据库脚本**：运行 `music-server/sql/search_history.sql` 创建搜索历史表
2. **重启后端服务**：确保新代码生效
3. **测试功能**：尝试搜索和收藏操作，确认记录功能正常








